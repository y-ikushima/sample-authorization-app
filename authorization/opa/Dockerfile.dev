FROM golang:1.21-alpine AS builder

WORKDIR /build

# ビルドに必要なツールをインストール
RUN apk add --no-cache git

# 依存関係をコピーしてダウンロード
COPY go.mod go.sum ./
RUN go mod download

# ソースコードをコピー
COPY . .

# デバッグ：ファイル一覧を表示
RUN ls -la

# バイナリをビルド（詳細なエラー情報付き）
RUN CGO_ENABLED=0 GOOS=linux go build -v -o opa-server .

# ビルド後のファイル確認
RUN ls -la opa-server

# 実行用の軽量イメージ
FROM alpine:latest

RUN apk --no-cache add ca-certificates
WORKDIR /app

# ビルドしたバイナリと設定ファイルをコピー
COPY --from=builder /build/opa-server .
COPY --from=builder /build/policy.rego .
COPY --from=builder /build/config.yaml .

# ファイル確認
RUN ls -la

# 実行権限を確実に付与
RUN chmod +x ./opa-server

# ポート8081を公開
EXPOSE 8081

# サーバーを起動
CMD ["./opa-server"] 